# データベース設計の流れ

## 仕様

仕様は次の通りです。サービスのイメージとしては ABEMA を頭に思い浮かべてください。

---

- ドラマ1、ドラマ2、アニメ1、アニメ2、スポーツ、ペットなど、複数のチャンネルがある。
  [x] チャンネルにチャンネル名がある。

- 各チャンネルの下では時間帯ごとに番組枠が1つ設定されており、番組が放映される
  [x] 番組枠に時間帯がある。
  [x] チャンネルと番組枠が関係。
  [x] 一つのチャンネルは複数の番組枠を持つ、一つの番組枠は、一つのチャンネルを持つ。||--|{
  [x] 番組枠と番組が関係。
  ~一つの番組枠は一つの番組を持つ、一つの番組は複数の番組枠を持つ。}|--||~

- 番組はシリーズになっているものと単発ものがある。シリーズになっているものはシーズンが1つものと、シーズン1、シーズン2のように複数シーズンのものがある。各シーズンの下では各エピソードが設定されている。
  [x] 番組にシリーズと単発(1話のみ)がある。 NULLで対応する。
  [x] シリーズには、単発シーズンと複数シーズンがある。
  [x] シーズンにエピソードがある。とういことは、単発はシーズン1の１エピソードのみの解釈か。
  [x] 一つの番組は、複数のシーズンがある、一つのシーズンは一つの番組がある。|o -- o{
  [x] 一つのシーズンには、複数のエピソードがある。一つのエピソードには、一つのシーズンがある。||--|{

- 再放送もあるため、ある番組が複数チャンネルの異なる番組枠で放映されることはある。
  [x] 番組はチャンネルごとに決まっているわけではない。

- 番組の情報として、タイトル、番組詳細、ジャンルが画面上に表示される。
  [x] 番組にタイトル、番組詳細、ジャンルがある。

- 各エピソードの情報として、シーズン数、エピソード数、タイトル、エピソード詳細、動画時間、公開日、視聴数が画面上に表示される。単発のエピソードの場合はシーズン数、エピソード数は表示されない。
  [x] ~エピソードにシーズン数~、エピソード数、タイトル、エピソード詳細、動画時間、公開日、視聴数がある。
  [x] 上記は少し辻褄が合わないと感じるので、当初通り、シーズンとエピソードはテーブルをわけ、関連させることで仕様を保つ

- ジャンルとしてアニメ、映画、ドラマ、ニュースなどがある。各番組は1つ以上のジャンルに属する。
  [x] ジャンルにアニメ、映画、ドラマ、ニュースがある。これは属性
  [x] 番組は1つ以上のジャンルに属す。下記に関係を記述
  [x] 一つの番組は複数の番組をもつ、一つのジャンルは複数の番組をもつ {--}

- KPIとして、チャンネルの番組枠のエピソードごとに視聴数を記録する。なお、一つのエピソードは複数の異なるチャンネル及び番組枠で放送されることがあるので、属するチャンネルの番組枠ごとに視聴数がどうだったかも追えるようにする。
  [x] チャンネルの番組枠のエピソードごと？チャンネルごとにエピソードの視聴回数。

番組、シーズン、エピソードの関係について、以下のようなイメージです(シリーズになっているものの例)。

番組：鬼滅の刃
シーズン：1
エピソード：1話、2話、...、26話

---

1. 論理設計
   1. エンティティの定義
      - 物理的 : なし
      - 抽象的 : ~ユーザー~(仕様外)、チャンネル、番組枠、番組、エピソード、シーズン、ジャンル、
      - イベント/取引 : 視聴歴(KPI)

   2. 正規化
      1. 1NF
         - チャンネルテーブル
           - チャンネルID (PK)
           - チャンネル名

         - 番組枠テーブル
           - 番組枠ID (PK)
           - 番組枠(開始時間 YYYY-MM-DD HH:MM:SS)
           <!-- 最初は1h単位だから0〜23で表現できると考えたが、ABEMAをみると
                枠を跨ぎ使っている場合があるので終了がいるかも -->
           - 番組枠(終了時間時間 YYYY-MM-DD HH:MM:SS)
           - チャンネルID (FK)
           - 番組ID (FK)
           - エピソードID (FK)
              <!-- 仕様の「再放送もあるため、ある番組が複数チャンネルの異なる番組枠で放映されることはある。」があるので番組枠がエピソードを持つ必要があると考える。 -->

         - 番組テーブル
           - 番組ID (PK)
           - タイトル
           - 番組詳細
           - ジャンルID (FK)

         - シーズンテーブル
           - シーズンID (PK)
           - シーズン
           - 番組ID (FK)

         - エピソードテーブル
           - エピソードID (PK)
           - エピソード数
           - タイトル
           - エピソード詳細
           - 動画時間
           - 開日
           - ~視聴数~
              <!-- 仕様でチャンネルの番組枠のエピソードごとに視聴数を記録があり、
                    番組テーブルととエピソード間にシーズンテーブル入れたので表現が
                    難しいと感じるので別テーブルを作る。それに要件が二つあるから
                    分けた方がいいかも。-->
           - シーズンID (FK)

         - ジャンルテーブル
           - ジャンル (PK)
           - ジャンル名

         - 番組-ジャンル中間テーブル
           - 番組-ジャンル中間ID(PK)
           - 番組ID (FK)
           - ジャンル (FK)

         - KPIテーブル
           - KPIテーブルID (PK)
           - 視聴数
           - 番組枠ID (FK)
           - エピソードID (FK)

      1. 2NF
         - チャンネルテーブル
           - チャンネルID (PK)
           - チャンネル名

         - 番組枠テーブル
           - 番組枠ID (PK)
           - 番組枠(開始時間 YYYY-MM-DD HH:MM:SS)
           - 番組枠(終了時間時間 YYYY-MM-DD HH:MM:SS)
           - チャンネルID (FK)
           - 番組ID (FK)
           - エピソードID (FK)

         - 番組テーブル
           - 番組ID (PK)
           - タイトル
           - 番組詳細
           - ジャンルID (FK)

         - シーズンテーブル
           - シーズンID (PK)
           - シーズン
           - 番組ID (FK)

         - エピソードテーブル
           - エピソードID (PK)
           - エピソード数
           - タイトル
           - エピソード詳細
           - 動画時間
           - 開日
           - シーズンID (FK)

         - ジャンルテーブル
           - ジャンル (PK)
           - ジャンル名

         - 番組-ジャンル中間テーブル
           - 番組-ジャンル中間ID(PK)
           - 番組ID (FK)
           - ジャンル (FK)

         - KPIテーブル
           - KPIテーブルID (PK)
           - 視聴数
           - 番組枠ID (FK)
           - エピソードID (FK)

      1. 3NF
         - チャンネルテーブル
           - チャンネルID (PK)
           - チャンネル名

         - 番組枠テーブル
           - 番組枠ID (PK)
           - 番組枠(開始時間 YYYY-MM-DD HH:MM:SS)
           - 番組枠(終了時間時間 YYYY-MM-DD HH:MM:SS)
           - チャンネルID (FK)
             <!-- 番組IDとエピソードIDが推移的従属になっている。
                   一方で、一つの番組枠は複数のエピソードを持て、一つのエピソードは複数の番組枠も持てるので
                   多対多の関係にもなる。 一時間枠に30分エピソード*2もあるので多対多を考える。-->
           - ~番組ID (FK)~ <!-- 1つの番組枠に1つの番組しか入らないわけではないので誤り -->
           - ~エピソードID (FK)~ <!-- 中間テーブルで表現-->

         - 番組テーブル
           - 番組ID (PK)
           - タイトル
           - 番組詳細
           - ~ジャンルID (FK)~ <!-- 中間テーブルで表現 -->

         - シーズンテーブル
           - シーズンID (PK)
           - シーズン
           - 番組ID (FK)

         - エピソードテーブル
           - エピソードID (PK)
           - エピソード数
           - タイトル
           - エピソード詳細
           - 動画時間
           - 公開日
           - シーズンID (FK)

         - 番組枠-エピソードテーブル
           - 番組枠-エピソードID (PK)
           - 放送順
           - 番組枠ID (FK)
           - エピソードID (FK)

         - ジャンルテーブル
           - ジャンル (PK)
           - ジャンル名

         - 番組-ジャンル中間テーブル
           - 番組-ジャンル中間ID(PK)
           - 番組ID (FK)
           - ジャンル (FK)

         - KPIテーブル
           - KPIテーブルID (PK)
           - 視聴数
           - 番組枠-エピソードID (FK)

      1. BCNF
         - チャンネルテーブル
           - チャンネルID (PK)
           - チャンネル名

         - 番組枠テーブル
           - 番組枠ID (PK)
           - 番組枠(開始時間 YYYY-MM-DD HH:MM:SS)
           - 番組枠(終了時間時間 YYYY-MM-DD HH:MM:SS)
           - チャンネルID (FK)
           <!-- 番組IDとエピソードIDが推移的従属になっている。
                 一方で、一つの番組枠は複数のエピソードを持て、一つのエピソードは複数の番組枠も持てるので
                 多対多の関係にもなる。 一時間枠に30分エピソード*2もあるので多対多を考える。-->
           - ~番組ID (FK)~ <!-- 1つの番組枠に1つの番組しか入らないわけではないので誤り -->
           - ~エピソードID (FK)~ <!-- 中間テーブルで表現-->

         - 番組テーブル
           - 番組ID (PK)
           - タイトル
           - 番組詳細
           - ~ジャンルID (FK)~ <!-- 中間テーブルで表現 -->

         - シーズンテーブル
           - シーズンID (PK)
           - シーズン
           - 番組ID (FK)

         - エピソードテーブル
           - エピソードID (PK)
           - エピソード数
           - タイトル
           - エピソード詳細
           - 動画時間
           - 公開日
           - シーズンID (FK)

         - 番組枠-エピソードテーブル
           - 番組枠-エピソードID (PK)
           - ~放送順~ <!-- 30分*2とかで考えてたが、実質ぴったりのエピソードはないので -->
           - 開始時間
           - 視聴数
           - 番組枠ID (FK)
           - エピソードID (FK)

         - ジャンルテーブル
           - ジャンル (PK)
           - ジャンル名

         - 番組-ジャンル中間テーブル
           - 番組-ジャンル中間ID(PK)
           - 番組ID (FK)
           - ジャンル (FK)

         - ~KPIテーブル~ <!-- 番組枠-エピソードテーブルで足りてる -->
           - ~KPIテーブルID (PK)~
           - ~視聴数~
           - ~番組枠-エピソードID (FK)~

   3. ER 図作成

2. 物理設計
   1. テーブル定義
   2. インデックス設計
